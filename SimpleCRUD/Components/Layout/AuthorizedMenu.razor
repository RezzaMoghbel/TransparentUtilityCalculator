@using Microsoft.AspNetCore.Components.Authorization
@using SimpleCRUD.Components.Utils
@using System.Reflection         
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using SimpleCRUD.Data.Models
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment HostEnv
@inject AuthenticationStateProvider AuthProvider
@inject SupportPermissionService PermissionService
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<div class="nav-item px-3">
    <NavLink class="nav-link" href="/dashboard" Match="NavLinkMatch.All">
        <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Dashboard
    </NavLink>
</div>

<div class="nav-item px-3">
    <NavLink class="nav-link" href="Account/Manage">
        <span class="bi bi-person-fill-nav-menu" aria-hidden="true"></span> @Helpers.GetNameFromUsername(UserName)
    </NavLink>
</div>

<div class="nav-item px-3">
    <NavLink class="nav-link" href="changelog">
        <span class="bi bi-journal-text-nav-menu" aria-hidden="true"></span> What's New
    </NavLink>
</div>

@if (showUserSupportLinks)
{
    @if (!isAdmin)
    {
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="/support/my-tickets">
                <span class="bi bi-life-preserver" aria-hidden="true"></span> My Tickets
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="/support/announcements">
                <span class="bi bi-megaphone" aria-hidden="true"></span> Announcements
            </NavLink>
        </div>
    }
}

@if (showAdminSupportLinks)
{
    <div class="nav-item px-3">
        <NavLink class="nav-link" href="/support/admin/tickets">
            <span class="bi bi-people" aria-hidden="true"></span> Manage Tickets
        </NavLink>
    </div>
    <div class="nav-item px-3">
        <NavLink class="nav-link" href="/support/admin/announcements">
            <span class="bi bi-broadcast-pin" aria-hidden="true"></span> Manage Announcements
        </NavLink>
    </div>
}

<div class="nav-item px-3">
    <span class="text-white ms-2" style="font-size:.72rem; letter-spacing:.02em;">@appVersion (@environmentName)</span>
</div>

@code {
    [Parameter] public string? CurrentUrl { get; set; }
    [Parameter] public string? UserName { get; set; }

    private string environmentName = "";
    private string appVersion = "";
    private bool showUserSupportLinks;
    private bool showAdminSupportLinks;
    private bool isAdmin;

    protected override async Task OnInitializedAsync()
    {
        environmentName = HostEnv.EnvironmentName;

        var asm = Assembly.GetEntryAssembly();
        var infoVer = asm?.GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion;

        if (!string.IsNullOrWhiteSpace(infoVer))
        {
            // grab just "major.minor.patch" (e.g., 1.0.2 from "1.0.2+508c94f...")
            var m = Regex.Match(infoVer, @"^\d+\.\d+\.\d+");
            appVersion = m.Success ? "v"+m.Value : "v" + infoVer.Split('+')[0];
        }
        else
        {
            // fallback to assembly version (limit to 3 parts if present)
            appVersion = "v" + asm?.GetName().Version?.ToString(3) ?? "0.0.0";
        }

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        
        // Get userId from claims (no database query needed)
        var userId = UserManager.GetUserId(authState.User);
        
        // Query AccessLevelId directly using IDbContextFactory to avoid concurrency issues
        if (!string.IsNullOrWhiteSpace(userId))
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            var accessLevelId = await dbContext.Users
                .Where(u => u.Id == userId)
                .Select(u => u.AccessLevelId)
                .FirstOrDefaultAsync();
            isAdmin = accessLevelId >= 2;
        }
        else
        {
            isAdmin = false;
        }

        var permissions = await PermissionService.GetPermissionsAsync(authState.User);

        showUserSupportLinks = permissions.Tickets.Read || permissions.Announcements.Read;
        showAdminSupportLinks = permissions.Tickets.Update || permissions.Announcements.Update || permissions.Tickets.Delete || permissions.Announcements.Delete || permissions.Announcements.Create;
    }
}
