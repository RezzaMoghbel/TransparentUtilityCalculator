@page "/support/my-tickets/create"
@attribute [Authorize]
@rendermode InteractiveServer

@using SimpleCRUD.Components.Reuseables.Dialogs
@inject AuthenticationStateProvider AuthProvider
@inject IdentityUserHandler<string> IdentityUserHandler
@inject SupportTicketHandler TicketHandler
@inject SupportLookupHandler LookupHandler
@inject SupportPermissionService PermissionService
@inject ToastService ToastService
@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager

<Toast />

<AccessLevelView>
    <PageTitle>Create Ticket</PageTitle>

    <h1 class="mb-3">Create a support ticket</h1>

    @if (!canCreateTickets)
    {
        <div class="alert alert-warning">
            Your account does not have permission to create support tickets.
        </div>
    }
    else if (isLoading)
    {
        <p>Loading information...</p>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <p class="text-danger">@loadError</p>
    }
    else
    {
        <EditForm Model="@formModel" OnValidSubmit="HandleSubmit" @ref="editForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label class="form-label fw-semibold">Title</label>
                <InputText class="form-control" @bind-Value="formModel.Title" maxlength="200" />
                <ValidationMessage For="@(() => formModel.Title)" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Category</label>
                <select class="form-select" @bind="formModel.CategoryId">
                    <option value="" selected disabled hidden>Select a category</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
                <ValidationMessage For="@(() => formModel.CategoryId)" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Priority</label>
                <select class="form-select" @bind="formModel.PriorityId">
                    <option value="" selected disabled hidden>Select priority</option>
                    @foreach (var priority in priorities)
                    {
                        <option value="@priority.Id">@priority.Name</option>
                    }
                </select>
                <ValidationMessage For="@(() => formModel.PriorityId)" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Description</label>
                <InputTextArea class="form-control" rows="5" @bind-Value="formModel.Description" />
                <ValidationMessage For="@(() => formModel.Description)" />
            </div>

            <div class="text-muted small mb-3">
                Status will be set to <strong>@defaultStatusName</strong> when the ticket is created.
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary" type="button" @onclick="HandleSubmitClick" disabled="@isSaving">
                    @(isSaving ? "Saving..." : "Submit Ticket")
                </button>
                <button class="btn btn-outline-secondary" type="button" @onclick="HandleCancel">Cancel</button>
            </div>
        </EditForm>
    }

    <ConfirmationModal IsVisible="@showSubmitModal"
                       Title="Submit Ticket?"
                       ConfirmButtonText="Yes, Submit Ticket"
                       ConfirmButtonClass="btn-primary"
                       OnConfirm="ConfirmSubmit"
                       OnCancel="CancelSubmitModal">
        <p>Are you sure you want to submit this ticket? Once submitted, it will be visible to support staff.</p>
    </ConfirmationModal>

    <ConfirmationModal IsVisible="@showCancelModal"
                       Title="Discard Changes?"
                       ConfirmButtonText="Yes, Discard Changes"
                       ConfirmButtonClass="btn-danger"
                       OnConfirm="ConfirmCancel"
                       OnCancel="CancelCancelModal">
        <p>You have unsaved changes. Are you sure you want to cancel? All entered data will be lost.</p>
    </ConfirmationModal>
</AccessLevelView>

@code {
    private readonly List<IssueCategory> categories = new();
    private readonly List<TicketPriority> priorities = new();
    private readonly List<TicketStatus> statuses = new();

    private TicketCreateRequest formModel = new();
    private TicketCreateRequest initialModel = new(); // Store initial state for change detection
    private EditForm? editForm;
    private bool isLoading = true;
    private bool isSaving;
    private bool canCreateTickets;
    private string? loadError;
    private string? userId;
    private int buildingId;
    private string defaultStatusName = "Open";
    private bool showSubmitModal;
    private bool showCancelModal;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var appUser = await UserManager.GetUserAsync(authState.User);
        userId = appUser?.Id;
        buildingId = appUser?.BuildingId ?? 0;

        // Block Admins and higher from accessing user ticket creation page
        if (appUser?.AccessLevelId >= 2)
        {
            ToastService.ShowWarning("This page is only available to regular users. Admins should use the ticket management page.");
            NavManager.NavigateTo("/support/admin/tickets");
            return;
        }

        var permissionSet = await PermissionService.GetPermissionsAsync(authState.User);
        canCreateTickets = permissionSet.Tickets.Create;

        await LoadLookupsAsync();

        if (!string.IsNullOrEmpty(userId) && buildingId > 0)
        {
            formModel.CreatedByUserId = userId;
            formModel.BuildingId = buildingId;
        }

        // Store initial state after all defaults are set
        initialModel = new TicketCreateRequest
        {
            Title = formModel.Title,
            Description = formModel.Description,
            CategoryId = formModel.CategoryId,
            PriorityId = formModel.PriorityId,
            StatusId = formModel.StatusId,
            CreatedByUserId = formModel.CreatedByUserId,
            BuildingId = formModel.BuildingId
        };

        isLoading = false;
    }

    private async Task LoadLookupsAsync()
    {
        var statusResult = await LookupHandler.GetTicketStatusesAsync();
        if (statusResult.IsSuccess && statusResult.Data is not null)
        {
            statuses.Clear();
            statuses.AddRange(statusResult.Data);
            var openStatus = statuses.FirstOrDefault(s => string.Equals(s.Code, "OPEN", StringComparison.OrdinalIgnoreCase))
                             ?? statuses.FirstOrDefault();
            if (openStatus is not null)
            {
                formModel.StatusId = openStatus.Id;
                defaultStatusName = openStatus.Name;
            }
        }
        else
        {
            loadError = statusResult.ErrorMessage ?? "Unable to load statuses.";
            ToastService.ShowError(loadError);
        }

        var categoryResult = await LookupHandler.GetIssueCategoriesAsync();
        if (categoryResult.IsSuccess && categoryResult.Data is not null)
        {
            categories.Clear();
            categories.AddRange(categoryResult.Data);
            if (categories.Count > 0)
            {
                formModel.CategoryId = categories.First().Id;
            }
        }
        else
        {
            loadError = categoryResult.ErrorMessage ?? "Unable to load categories.";
            ToastService.ShowError(loadError);
        }

        var priorityResult = await LookupHandler.GetTicketPrioritiesAsync();
        if (priorityResult.IsSuccess && priorityResult.Data is not null)
        {
            priorities.Clear();
            priorities.AddRange(priorityResult.Data);
            var defaultPriority = priorities.FirstOrDefault(p => string.Equals(p.Code, "MEDIUM", StringComparison.OrdinalIgnoreCase))
                                  ?? priorities.FirstOrDefault();
            if (defaultPriority is not null)
            {
                formModel.PriorityId = defaultPriority.Id;
            }
        }
        else
        {
            loadError = priorityResult.ErrorMessage ?? "Unable to load priorities.";
            ToastService.ShowError(loadError);
        }
    }

    private void HandleSubmitClick()
    {
        // Validate form first
        if (editForm?.EditContext != null && !editForm.EditContext.Validate())
        {
            // Form is invalid, let validation messages show
            return;
        }

        // Form is valid, show confirmation modal
        showSubmitModal = true;
    }

    private void CancelSubmitModal()
    {
        showSubmitModal = false;
    }

    private async Task ConfirmSubmit()
    {
        showSubmitModal = false;
        await HandleSubmit();
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrEmpty(userId))
        {
            ToastService.ShowError("Unable to determine the current user.");
            return;
        }

        isSaving = true;

        var result = await TicketHandler.CreateTicketAsync(formModel);
        isSaving = false;

        if (!result.IsSuccess || result.Data is null)
        {
            ToastService.ShowError(result.ErrorMessage ?? "Failed to create ticket.");
            return;
        }

        var ticket = result.Data;
        ToastService.ShowSuccess("Ticket created successfully.");
        NavManager.NavigateTo($"/support/my-tickets/{ticket.Id}");
    }

    private void HandleCancel()
    {
        // Check if user has made any changes from the initial state
        var hasChanges = !string.IsNullOrWhiteSpace(formModel.Title) || 
                        !string.IsNullOrWhiteSpace(formModel.Description) ||
                        formModel.CategoryId != initialModel.CategoryId ||
                        formModel.PriorityId != initialModel.PriorityId;
        
        if (hasChanges)
        {
            showCancelModal = true;
        }
        else
        {
            NavManager.NavigateTo("/support/my-tickets");
        }
    }

    private void CancelCancelModal()
    {
        showCancelModal = false;
    }

    private void ConfirmCancel()
    {
        showCancelModal = false;
        NavManager.NavigateTo("/support/my-tickets");
    }
}

