@page "/support/admin/announcements/edit/{id:int}"
@attribute [Authorize]
@rendermode InteractiveServer

@using SimpleCRUD.Components.Reuseables.Dialogs
@inject AuthenticationStateProvider AuthProvider
@inject SupportAnnouncementHandler AnnouncementHandler
@inject SupportLookupHandler LookupHandler
@inject SupportPermissionService PermissionService
@inject ToastService ToastService
@inject NavigationManager NavManager

<Toast />

<AccessLevelView MinimumAccessLevelName="Admin">
    <PageTitle>Edit Announcement</PageTitle>

    <h1 class="mb-3">Edit Announcement</h1>

    @if (!canUpdateAnnouncements)
    {
        <div class="alert alert-warning">You do not have permission to update announcements.</div>
    }
    else if (isLoading)
    {
        <p>Loading announcement...</p>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <div class="alert alert-danger">@loadError</div>
    }
    else
    {
        <EditForm Model="@formModel" OnValidSubmit="HandleSubmit" @ref="editForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="mb-3">
                <label class="form-label fw-semibold">Title</label>
                <InputText class="form-control" @bind-Value="formModel.Title" maxlength="200" />
                <ValidationMessage For="@(() => formModel.Title)" />
            </div>

            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label fw-semibold">Scope</label>
                    <select class="form-select" @onchange="OnScopeChanged" value="@formModel.ScopeId">
                        @foreach (var scope in scopes)
                        {
                            <option value="@scope.Id">@scope.Name</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label fw-semibold">Building</label>
                    <select class="form-select" @bind="formModel.BuildingId" disabled="@IsGlobalScope">
                        <option value="">All buildings</option>
                        @foreach (var building in buildings)
                        {
                            <option value="@building.Id">@building.Name</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" @bind="formModel.CategoryId">
                        <option value="">General</option>
                        @foreach (var category in categories)
                        {
                            <option value="@category.Id">@category.Name</option>
                        }
                    </select>
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label fw-semibold">Body</label>
                <InputTextArea class="form-control" rows="8" @bind-Value="formModel.Body" />
                <ValidationMessage For="@(() => formModel.Body)" />
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Publish date</label>
                <InputDate class="form-control" @bind-Value="formModel.PublishedAt" disabled="true" />
                <small class="form-text text-muted">Publish date cannot be changed</small>
            </div>

            <div class="form-check form-switch mb-2">
                <InputCheckbox class="form-check-input" @bind-Value="formModel.IsActive" @bind-Value:after="OnIsActiveChanged" />
                <label class="form-check-label">Active</label>
            </div>
            <div class="form-check form-switch mb-3">
                <InputCheckbox class="form-check-input" @bind-Value="formModel.IsArchived" @bind-Value:after="OnIsArchivedChanged" />
                <label class="form-check-label">Archived</label>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary" type="button" @onclick="HandleSaveClick" disabled="@isSaving">
                    @(isSaving ? "Saving..." : "Save changes")
                </button>
                <button class="btn btn-outline-secondary" type="button" @onclick="HandleCancel">Cancel</button>
            </div>
        </EditForm>
    }

    <ConfirmationModal IsVisible="@showSaveModal"
                       Title="Save Changes?"
                       ConfirmButtonText="Yes, Save Changes"
                       ConfirmButtonClass="@(saveModalIsDangerous ? "btn-danger" : "btn-primary")"
                       HeaderClass="@(saveModalIsDangerous ? "bg-danger text-white" : "")"
                       OnConfirm="ConfirmSave"
                       OnCancel="CancelSaveModal">
        <p>Are you sure you want to save the following changes?</p>
        @if (saveModalWarningMessage != null)
        {
            <p class="mb-0 mt-2 fw-semibold text-danger">@saveModalWarningMessage</p>
        }
    </ConfirmationModal>

    <ConfirmationModal IsVisible="@showCancelModal"
                       Title="Discard Changes?"
                       ConfirmButtonText="Yes, Discard Changes"
                       ConfirmButtonClass="btn-danger"
                       OnConfirm="ConfirmCancel"
                       OnCancel="CancelCancelModal">
        <p>You have unsaved changes. Are you sure you want to cancel? All entered data will be lost.</p>
    </ConfirmationModal>

    <ConfirmationModal IsVisible="@showDeactivateModal"
                       Title="Deactivate Announcement?"
                       ConfirmButtonText="Yes, Deactivate"
                       ConfirmButtonClass="btn-danger"
                       HeaderClass="bg-danger text-white"
                       OnConfirm="ConfirmDeactivate"
                       OnCancel="CancelDeactivateModal">
        <p>You are deactivating this announcement. Are you sure?</p>
    </ConfirmationModal>

    <ConfirmationModal IsVisible="@showArchiveModal"
                       Title="Archive Announcement?"
                       ConfirmButtonText="Yes, Archive"
                       ConfirmButtonClass="btn-danger"
                       HeaderClass="bg-danger text-white"
                       OnConfirm="ConfirmArchive"
                       OnCancel="CancelArchiveModal">
        <p>You are archiving this announcement. Are you sure?</p>
    </ConfirmationModal>

</AccessLevelView>

@code {
    [Parameter] public int Id { get; set; }

    private readonly List<IssueCategory> categories = new();
    private readonly List<BuildingOption> buildings = new();
    private readonly List<AnnouncementScope> scopes = new();

    private AnnouncementUpdateRequest formModel = new();
    private AnnouncementUpdateRequest originalModel = new();
    private bool canUpdateAnnouncements;
    private bool isLoading = true;
    private bool isSaving;
    private string? loadError;
    private bool showSaveModal;
    private bool showCancelModal;
    private bool showDeactivateModal;
    private bool showArchiveModal;
    private bool pendingIsActive;
    private bool pendingIsArchived;
    private bool saveModalIsDangerous;
    private string? saveModalWarningMessage;
    private EditForm? editForm;

    private bool IsGlobalScope => scopes.FirstOrDefault(s => s.Id == formModel.ScopeId)?.Code == "GLOBAL";

    private bool HasChanges
    {
        get
        {
            return formModel.Title != originalModel.Title ||
                   formModel.Body != originalModel.Body ||
                   formModel.CategoryId != originalModel.CategoryId ||
                   formModel.ScopeId != originalModel.ScopeId ||
                   formModel.BuildingId != originalModel.BuildingId ||
                   formModel.IsActive != originalModel.IsActive ||
                   formModel.IsArchived != originalModel.IsArchived;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        await InitializeAsync();
        isLoading = false;
    }

    private async Task InitializeAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var permissions = await PermissionService.GetPermissionsAsync(authState.User);
        canUpdateAnnouncements = permissions.Announcements.Update;

        await LoadLookupsAsync();
        await LoadAnnouncementAsync();
    }

    private async Task LoadLookupsAsync()
    {
        categories.Clear();
        buildings.Clear();
        scopes.Clear();

        var categoryResult = await LookupHandler.GetIssueCategoriesAsync();
        if (categoryResult.IsSuccess && categoryResult.Data is not null)
        {
            categories.AddRange(categoryResult.Data);
        }

        var buildingResult = await LookupHandler.GetActiveBuildingsAsync();
        if (buildingResult.IsSuccess && buildingResult.Data is not null)
        {
            buildings.AddRange(buildingResult.Data);
        }

        var scopeResult = await LookupHandler.GetAnnouncementScopesAsync();
        if (scopeResult.IsSuccess && scopeResult.Data is not null)
        {
            scopes.AddRange(scopeResult.Data);
        }
    }

    private async Task LoadAnnouncementAsync()
    {
        var result = await AnnouncementHandler.GetAnnouncementByIdAsync(Id);
        if (!result.IsSuccess || result.Data is null)
        {
            loadError = result.ErrorMessage ?? "Announcement not found.";
            return;
        }

        var announcement = result.Data;
        formModel = new AnnouncementUpdateRequest
        {
            Id = announcement.Id,
            Title = announcement.Title,
            Body = announcement.Body,
            CategoryId = announcement.CategoryId,
            ScopeId = announcement.ScopeId,
            BuildingId = announcement.BuildingId,
            SourceTicketId = announcement.SourceTicketId,
            IsActive = announcement.IsActive,
            IsArchived = announcement.IsArchived,
            PublishedAt = announcement.PublishedAt
        };

        // Store original state for comparison
        originalModel = new AnnouncementUpdateRequest
        {
            Id = formModel.Id,
            Title = formModel.Title,
            Body = formModel.Body,
            CategoryId = formModel.CategoryId,
            ScopeId = formModel.ScopeId,
            BuildingId = formModel.BuildingId,
            SourceTicketId = formModel.SourceTicketId,
            IsActive = formModel.IsActive,
            IsArchived = formModel.IsArchived,
            PublishedAt = formModel.PublishedAt
        };
    }

    private Task OnScopeChanged(ChangeEventArgs e)
    {
        // Manually update the bound value
        if (int.TryParse(e.Value?.ToString(), out var scopeId))
        {
            formModel.ScopeId = scopeId;
        }

        // Then run your custom logic
        if (IsGlobalScope)
        {
            formModel.BuildingId = null;
        }

        // Trigger state update to reflect changes
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void HandleSaveClick()
    {
        // If no changes, treat as cancel (just navigate away)
        if (!HasChanges)
        {
            NavManager.NavigateTo("/support/admin/announcements");
            return;
        }

        // Validate form first
        if (editForm?.EditContext != null && !editForm.EditContext.Validate())
        {
            // Form is invalid, let validation messages show
            return;
        }

        // Check if announcement is being deactivated or archived
        bool isBeingDeactivated = originalModel.IsActive && !formModel.IsActive;
        bool isBeingArchived = !originalModel.IsArchived && formModel.IsArchived;

        // Set warning message and danger styling
        if (isBeingDeactivated && isBeingArchived)
        {
            saveModalWarningMessage = "This announcement is going to be deactivated and archived.";
            saveModalIsDangerous = true;
        }
        else if (isBeingDeactivated)
        {
            saveModalWarningMessage = "This announcement is going to be deactivated.";
            saveModalIsDangerous = true;
        }
        else if (isBeingArchived)
        {
            saveModalWarningMessage = "This announcement is going to be archived.";
            saveModalIsDangerous = true;
        }
        else
        {
            saveModalWarningMessage = null;
            saveModalIsDangerous = false;
        }

        // Show confirmation modal
        showSaveModal = true;
    }

    private void CancelSaveModal()
    {
        showSaveModal = false;
    }

    private async Task ConfirmSave()
    {
        showSaveModal = false;
        await HandleSubmit();
    }

    private async Task HandleSubmit()
    {
        if (!canUpdateAnnouncements)
        {
            return;
        }

        if (IsGlobalScope)
        {
            formModel.BuildingId = null;
        }

        isSaving = true;
        var result = await AnnouncementHandler.UpdateAnnouncementAsync(formModel);
        isSaving = false;

        if (!result.IsSuccess)
        {
            ToastService.ShowError(result.ErrorMessage ?? "Failed to update announcement.");
            return;
        }

        ToastService.ShowSuccess("Announcement updated.");
        NavManager.NavigateTo($"/support/admin/announcements/{formModel.Id}");
    }

    private void HandleCancel()
    {
        // If no changes, navigate directly without modal
        if (!HasChanges)
        {
            NavManager.NavigateTo("/support/admin/announcements");
            return;
        }

        // Show confirmation modal if changes exist
        showCancelModal = true;
    }

    private void CancelCancelModal()
    {
        showCancelModal = false;
    }

    private void ConfirmCancel()
    {
        showCancelModal = false;
        NavManager.NavigateTo("/support/admin/announcements");
    }

    private void OnIsActiveChanged()
    {
        // Only show modal if changing from true to false
        if (!formModel.IsActive && originalModel.IsActive)
        {
            pendingIsActive = false;
            showDeactivateModal = true;
            // Revert the change until confirmed
            formModel.IsActive = originalModel.IsActive;
        }
    }

    private void OnIsArchivedChanged()
    {
        // Only show modal if changing from false to true
        if (formModel.IsArchived && !originalModel.IsArchived)
        {
            pendingIsArchived = true;
            showArchiveModal = true;
            // Revert the change until confirmed
            formModel.IsArchived = originalModel.IsArchived;
        }
    }

    private void ConfirmDeactivate()
    {
        showDeactivateModal = false;
        formModel.IsActive = pendingIsActive;
        StateHasChanged();
    }

    private void CancelDeactivateModal()
    {
        showDeactivateModal = false;
        formModel.IsActive = originalModel.IsActive;
        StateHasChanged();
    }

    private void ConfirmArchive()
    {
        showArchiveModal = false;
        formModel.IsArchived = pendingIsArchived;
        StateHasChanged();
    }

    private void CancelArchiveModal()
    {
        showArchiveModal = false;
        formModel.IsArchived = originalModel.IsArchived;
        StateHasChanged();
    }

}

