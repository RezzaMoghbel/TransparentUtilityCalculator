@page "/direct-debits/create"
@attribute [Authorize]

@using SimpleCRUD.Components.Utils
@using SimpleCRUD.DTO.Utility.DirectDebits
@using SimpleCRUD.DTO.Identity
@using SimpleCRUD.Services
@using SimpleCRUD.Components.Reuseables.Toasts
@using SimpleCRUD.Components.Reuseables.Dialogs
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using System.Globalization
@using SimpleCRUD.Engine.DirectDebit

@inject NavigationManager NavManager
@inject ToastService ToastService
@inject AuthenticationStateProvider AuthProvider

<!--Inject your handlers -->
@inject IdentityUserHandler<string> IdentityUserHandler
@inject DirectDebitHandler<DirectDebitCreate> DirectDebitCreateHandler
@inject DirectDebitHandler<SimpleCRUD.DTO.Identity.UtilityProvider> ProvidersHandler

@rendermode InteractiveServer

<style>
    /* mobile-friendly tweaks */
    @@media (max-width: 576px) {
        .form-floating > label {
            font-size: .9rem;
        }

        .section-title {
            margin-top: .75rem;
        }
    }
</style>

<Toast />

<AccessLevelView>
    <PageTitle>Create new Direct Debit</PageTitle>

    <h3>Create a new direct debit</h3>

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <p class="text-danger">@loadError</p>
    }
    else
    {
        <EditForm Model="ddCreate" @ref="editForm" FormName="createDirectDebitForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <!-- Payment Details -->
            <h5 class="section-title mt-3">Payment Details</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputDate @bind-Value="ddCreate.PaymentDate" class="form-control" id="paymentDate" />
                    <ValidationMessage For="@(() => ddCreate.PaymentDate)" />
                    <label for="paymentDate">Payment Date</label>
                </div>

                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputNumber @bind-Value="ddCreate.Amount" step="0.01" inputmode="decimal" min="0.01"
                                 class="form-control" id="amount" />
                    <ValidationMessage For="@(() => ddCreate.Amount)" />
                    <label for="amount">Amount (Â£)</label>
                </div>

                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputSelect @bind-Value="ddCreate.UtilityProviderId" class="form-control" id="utilityProviderId">
                        <option value="">Select a provider (Optional)</option>
                        @if (providersResult?.Data != null)
                        {
                            @foreach (var provider in providersResult.Data)
                            {
                                <option value="@provider.Id">@provider.Name</option>
                            }
                        }
                    </InputSelect>
                    <label for="utilityProviderId">Utility Provider</label>
                </div>
            </div>

            <!-- Status -->
            <h5 class="section-title mt-3">Status</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputSelect @bind-Value="ddCreate.PaymentStatus" class="form-control" id="paymentStatus">
                        <option value="Pending">Pending</option>
                        <option value="Paid" selected>Paid</option>
                        <option value="Failed">Failed</option>
                        <option value="Cancelled">Cancelled</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => ddCreate.PaymentStatus)" />
                    <label for="paymentStatus">Payment Status</label>
                </div>
            </div>

            <!-- Notes -->
            <h5 class="section-title mt-3">Notes</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12">
                    <InputTextArea @bind-Value="ddCreate.Notes" class="form-control" id="notes" rows="3" />
                    <ValidationMessage For="@(() => ddCreate.Notes)" />
                    <label for="notes">Notes</label>
                </div>
            </div>

            <div class="d-flex justify-content-start gap-2 mt-3 flex-wrap">
                <button class="btn btn-primary" type="button" style="min-width:160px" @onclick="HandleSaveClick">Save</button>
                <button class="btn btn-secondary" type="button"
                        @onclick="GoBack">
                    Cancel
                </button>
            </div>
        </EditForm>

        <!-- Confirmation Modal -->
        <ConfirmationModal IsVisible="@showConfirmationModal"
                          Title="Confirm Create Direct Debit"
                          ConfirmButtonText="Create"
                          ConfirmButtonClass="btn-primary"
                          OnConfirm="HandleValidSubmit"
                          OnCancel="CancelConfirmation">
            <div>
                <p class="mb-3">Please review the details before creating this direct debit:</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tbody>
                            <tr>
                                <th class="bg-light" style="width: 40%;">Amount</th>
                                <td class="fw-bold">@ddCreate.Amount?.ToPounds(2)</td>
                            </tr>
                            <tr>
                                <th class="bg-light">Payment Date</th>
                                <td>@ddCreate.PaymentDate?.ToString("yyyy-MMM-dd")</td>
                            </tr>
                            <tr>
                                <th class="bg-light">Provider</th>
                                <td>@(GetProviderName(ddCreate.UtilityProviderId) ?? "N/A")</td>
                            </tr>
                            <tr>
                                <th class="bg-light">Payment Status</th>
                                <td><span class="badge @GetStatusBadgeClass(ddCreate.PaymentStatus ?? "")">@(ddCreate.PaymentStatus ?? "")</span></td>
                            </tr>
                            @if (!string.IsNullOrWhiteSpace(ddCreate.Notes))
                            {
                                <tr>
                                    <th class="bg-light">Notes</th>
                                    <td>@ddCreate.Notes</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </ConfirmationModal>
    }
</AccessLevelView>

@code {
    private DirectDebitCreate ddCreate = new();
    private Result<IEnumerable<SimpleCRUD.DTO.Identity.UtilityProvider>>? providersResult;
    private List<SimpleCRUD.DTO.Identity.UtilityProvider> Providers = new();
    private bool isLoading = true;
    private string? loadError;
    private string? userName;
    private string? userID;
    private bool showConfirmationModal = false;
    private EditForm? editForm;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name;

        var idResult = await IdentityUserHandler.GetUserIdByUsername(userName);
        userID = idResult.Data;

        if (!string.IsNullOrEmpty(userID))
        {
            ddCreate.UserId = userID;
        }

        // Load providers
        providersResult = await ProvidersHandler.GetAllActiveProviders();

        if (!providersResult.IsSuccess)
        {
            loadError = providersResult?.ErrorMessage;
            isLoading = false;
            return;
        }

        Providers = providersResult.Data?.ToList() ?? [];

        isLoading = false;
    }

    private string? GetProviderName(int? providerId)
    {
        if (!providerId.HasValue) return null;
        return Providers.FirstOrDefault(p => p.Id == providerId.Value)?.Name;
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Paid" => "bg-success",
        "Pending" => "bg-warning text-dark",
        "Failed" => "bg-danger",
        "Cancelled" => "bg-secondary",
        _ => "bg-secondary"
    };

    private async Task HandleSaveClick()
    {
        // Validate the form
        if (editForm?.EditContext != null && editForm.EditContext.Validate())
        {
            // Form is valid, show confirmation modal
            showConfirmationModal = true;
            await InvokeAsync(StateHasChanged);
        }
        // If validation fails, the ValidationSummary will show errors
    }

    private async Task CancelConfirmation()
    {
        showConfirmationModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleValidSubmit()
    {
        showConfirmationModal = false;
        await InvokeAsync(StateHasChanged);

        if (string.IsNullOrEmpty(userID))
        {
            ToastService.ShowError($"Failed to create a new direct debit, try again later!");
            return;
        }

        var result = await DirectDebitCreateHandler.CreateDirectDebit(ddCreate);

        if (result.IsSuccess)
        {
            ToastService.ShowSuccess("Direct debit added!");
            NavManager.NavigateTo("/direct-debits");
        }
        else
        {
            ToastService.ShowError($"Failed to create a new direct debit, try again later! {result.ErrorMessage}");
        }
    }

    private void GoBack() => NavManager.NavigateTo("/direct-debits");
}
