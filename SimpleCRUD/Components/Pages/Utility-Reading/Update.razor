@page "/utility-readings/update/{Id:int}"
@attribute [Authorize]
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components    
@using SimpleCRUD.Components.Utils
@using SimpleCRUD.DTO.Utility.Readings
@using SimpleCRUD.DTO.Utility.Types
@using SimpleCRUD.Services
@using SimpleCRUD.Components.Reuseables.Toasts
@using SimpleCRUD.Components.Reuseables.Dialogs
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using SimpleCRUD.Components.Reuseables.Utility
@using SimpleCRUD.Engine.Test            
@inject NavigationManager NavManager
@inject ToastService ToastService
@inject AuthenticationStateProvider AuthProvider

<!-- inject handlers -->
@inject IdentityUserHandler<string> IdentityUserHandler
@inject UtilityReadingHandler<UtilityType> UtilityTypesHandler
@inject UtilityReadingHandler<UtilityReading> UtilityReadHandler
@inject UtilityReadingHandler<UtilityReadingUpdate> UtilityUpdateHandler

<style>
    /* mobile-friendly tweaks */
    .readonly-box {
        white-space: pre-wrap;
        word-break: break-word;
    }

    @@media (max-width: 576px) {
        .form-floating > label {
            font-size: .9rem;
        }

        .section-title {
            margin-top: .75rem;
        }
    }
</style>

<Toast />

<AccessLevelView>
    <PageTitle>Edit reading</PageTitle>

    <h3 class="py-3">
        <UtilityTypeActiveBadge UtilityType="@currentUtilityTypeName" ExtraText="reading (update)" />
    </h3>

    @if (isLoading)
    {
        <p>Loading…</p>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <p class="text-danger">@loadError</p>
    }
    else
    {
        <EditForm Model="urUpdate" @ref="editForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <!-- Top row -->
            <div class="row g-3">
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputDate @bind-Value="urUpdate.ReadingStartDate" class="form-control" id="readingStartDate" />
                    <ValidationMessage For="@(() => urUpdate.ReadingStartDate)" />
                    <label for="readingStartDate">Start date</label>
                </div>

                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputDate @bind-Value="urUpdate.ReadingEndDate" class="form-control" id="readingEndDate" />
                    <ValidationMessage For="@(() => urUpdate.ReadingEndDate)" />
                    <label for="readingEndDate">End date</label>
                </div>
            </div>

            <!-- Usage -->
            <h5 class="section-title mt-3">Usage</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputNumber @bind-Value="urUpdate.MeterStart" step="any" inputmode="decimal" min="0"
                                 class="form-control" id="meterStart" />
                    <ValidationMessage For="@(() => urUpdate.MeterStart)" />
                    <label for="meterStart">Meter start</label>
                </div>
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputNumber @bind-Value="urUpdate.MeterEnd" step="any" inputmode="decimal" min="0"
                                 class="form-control" id="meterEnd" />
                    <ValidationMessage For="@(() => urUpdate.MeterEnd)" />
                    <label for="meterEnd">Meter end</label>
                </div>
                <div class="form-floating mb-2 col-12 col-lg-4">
                    <input type="text" class="form-control" id="unitsUsed"
                           value="@($"{UnitsPreview:0.###} {CurrentUnitLabel}")" disabled>
                    <label for="unitsUsed">Units used</label>
                </div>
            </div>

            <!-- Rates -->
            <h5 class="section-title mt-3">Rates</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputNumber @bind-Value="urUpdate.UnitRate" step="any" inputmode="decimal" min="0"
                                 class="form-control" id="unitRate" />
                    <ValidationMessage For="@(() => urUpdate.UnitRate)" />
                    <label for="unitRate">Unit rate (per @CurrentUnitLabel)</label>
                </div>

                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    <InputNumber @bind-Value="urUpdate.StandingChargePerDay" step="any" inputmode="decimal" min="0"
                                 class="form-control" id="standingPerDay" />
                    <ValidationMessage For="@(() => urUpdate.StandingChargePerDay)" />
                    <label for="standingPerDay">Standing charge / day</label>
                </div>

                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-4">
                    @{
                        decimal.TryParse(urUpdate.VatRateFactor.ToString(), out decimal vatFactor);
                        var vatPct = PercentUtils.FactorToPercentValue(vatFactor, 2);
                    }
                    <input type="text" value="@($"{vatPct:0.#}% (×{vatFactor:0.00})")" class="form-control" id="vatRateFactor" disabled>
                    <label for="vatRateFactor">VAT</label>
                </div>
            </div>

            <!-- Notes -->
            <h5 class="section-title mt-3">Notes</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12">
                    <InputTextArea @bind-Value="urUpdate.Notes" class="form-control" id="notes" rows="3" />
                    <ValidationMessage For="@(() => urUpdate.Notes)" />
                    <label for="notes">Reading notes</label>
                </div>
            </div>

            <!-- Live preview -->
            <h5 class="section-title mt-3">Preview</h5>
            <div class="row g-3">
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-3">
                    <input type="text" class="form-control" id="previewDays" value="@DaysPreview" disabled>
                    <label for="previewDays">Days billed</label>
                </div>
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-3">
                    <input type="text" class="form-control" id="previewUsageCost" value="@UsageCostPreview.ToPounds(2)" disabled>
                    <label for="previewUsageCost">Usage cost</label>
                </div>
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-3">
                    <input type="text" class="form-control" id="previewStanding" value="@StandingTotalPreview.ToPounds(2)" disabled>
                    <label for="previewStanding">Standing total</label>
                </div>
                <div class="form-floating mb-2 col-12 col-sm-6 col-lg-3">
                    <input type="text" class="form-control" id="previewTotal" value="@TotalPreview.ToPounds(2)" disabled>
                    <label for="previewTotal">Estimated total</label>
                </div>
            </div>

            <div class="d-flex justify-content-start gap-2 mt-3 flex-wrap">
                <button class="btn btn-primary" type="button" style="min-width:160px" @onclick="HandleSaveClick">Save changes</button>
                <button class="btn btn-secondary" type="button"
                        @onclick="HandleCancelClick">
                    Cancel
                </button>
            </div>
        </EditForm>

        <!-- Confirmation Modal -->
        <ConfirmationModal IsVisible="@showConfirmationModal"
                          Title="Confirm Update Utility Reading"
                          ConfirmButtonText="Update"
                          ConfirmButtonClass="btn-primary"
                          OnConfirm="HandleValidSubmit"
                          OnCancel="CancelConfirmation">
            <div>
                <p class="mb-3">Please review the changes before saving:</p>
                @if (HasChanges)
                {
                    <div class="alert alert-info mb-3">
                        <strong>Changes detected:</strong> The following fields have been modified:
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Field</th>
                                    <th style="width: 35%;">Old Value</th>
                                    <th style="width: 35%;">New Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var change in GetChanges())
                                {
                                    <tr>
                                        <th class="bg-light">@change.Field</th>
                                        <td class="text-muted">@change.OldValue</td>
                                        <td class="text-primary fw-bold">@change.NewValue</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        No changes detected. The form values match the original values.
                    </div>
                }
            </div>
        </ConfirmationModal>

        <!-- Unsaved Changes Warning Modal -->
        <ConfirmationModal IsVisible="@showUnsavedChangesModal"
                          Title="Unsaved Changes"
                          ConfirmButtonText="Discard Changes"
                          ConfirmButtonClass="btn-danger"
                          HeaderClass="text-warning"
                          OnConfirm="ConfirmDiscardChanges"
                          OnCancel="CancelDiscardChanges">
            <div>
                <p class="mb-3"><strong>You have unsaved changes!</strong> If you cancel now, you will lose the following changes:</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Field</th>
                                <th style="width: 35%;">Old Value</th>
                                <th style="width: 35%;">New Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var change in GetChanges())
                            {
                                <tr>
                                    <th class="bg-light">@change.Field</th>
                                    <td class="text-muted">@change.OldValue</td>
                                    <td class="text-danger fw-bold">@change.NewValue</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <p class="mt-3 text-danger"><strong>Are you sure you want to discard these changes?</strong></p>
            </div>
        </ConfirmationModal>
    }
</AccessLevelView>

@code {
    [Parameter] public int Id { get; set; }

    private UtilityReadingUpdate urUpdate = new();
    private UtilityReadingUpdate originalValues = new();
    private List<UtilityType> UtilityTypes = new();
    private bool isLoading = true;
    private string? loadError;
    private string? userID;
    private bool showConfirmationModal = false;
    private bool showUnsavedChangesModal = false;
    private EditForm? editForm;

    private readonly (decimal Factor, string Label)[] VatOptions =
        [
        (1.00m, "0%"),
        (1.05m, "5%"),
        (1.10m, "10%"),
        (1.15m, "15%"),
        (1.20m, "20%")
    ];

    private readonly Dictionary<string, string> UnitsByName =
        new(StringComparer.OrdinalIgnoreCase)
            {
                ["Electricity"] = "kWh",
                ["Gas"] = "m3",
                ["Water-Hot"] = "m3",
                ["Water-Cold"] = "m3"
            };

    private string CurrentUnitLabel =>
        (currentUtilityTypeName is not null && UnitsByName.TryGetValue(currentUtilityTypeName, out var u))
            ? u : "unit";

    private string? currentUtilityTypeName =>
        UtilityTypes.FirstOrDefault(t => t.Id == urUpdate.UtilityTypeId)?.Name;

    // PREVIEW CALCS
    private decimal UnitsPreview => Math.Max(0m, (urUpdate.MeterEnd ?? 0m) - (urUpdate.MeterStart ?? 0m));
    private int DaysPreview => Math.Max(0, (int)(((urUpdate.ReadingEndDate?.Date ?? DateTime.MinValue)
                       - (urUpdate.ReadingStartDate?.Date ?? DateTime.MinValue)).TotalDays));
    private decimal? UsageCostPreview => UnitsPreview * urUpdate.UnitRate;
    private decimal? StandingTotalPreview => DaysPreview * urUpdate.StandingChargePerDay;
    private decimal? SubtotalPreview => UsageCostPreview + StandingTotalPreview;
    private decimal? TotalPreview => SubtotalPreview * (urUpdate.VatRateFactor == 0 ? 1 : urUpdate.VatRateFactor);

    protected override async Task OnInitializedAsync()
    {
        // Get current user id
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name;

        // Use injected handler
        var who = await IdentityUserHandler.GetUserIdByUsername(userName);
        if (!who.IsSuccess || string.IsNullOrEmpty(who.Data))
        {
            NavManager.NavigateTo("/utility-readings");
            return;
        }
        userID = who.Data;

        // Load utility types (for drop-down)
        var typesResult = await UtilityTypesHandler.GetAllUtilityTypes(true);
        if (!typesResult.IsSuccess)
        {
            loadError = typesResult.ErrorMessage;
            isLoading = false;
            return;
        }
        UtilityTypes = typesResult.Data?.ToList() ?? [];

        // Load the reading
        var uRResult = await UtilityReadHandler.GetUtilityReadingsByID(userID, Id);
        if (!uRResult.IsSuccess)
        {
            loadError = uRResult.ErrorMessage ?? "Failed to load the requested item.";
            isLoading = false;
            return;
        }
        var r = uRResult.Data?.FirstOrDefault();
        if (r is null || r.Id < 1)
        {
            loadError = "The requested item was not found.";
            isLoading = false;
            NavManager.NavigateTo("/utility-readings");
            return;
        }

        // Map to Update DTO
        urUpdate = new UtilityReadingUpdate
            {
                Id = r.Id,
                UtilityTypeId = r.UtilityTypeId,
                UserId = r.UserId,
                UnitRate = r.UnitRate,
                StandingChargePerDay = r.StandingChargePerDay,
                VatRateFactor = r.VatRateFactor,
                ReadingStartDate = r.ReadingStartDate,
                ReadingEndDate = r.ReadingEndDate,
                MeterStart = r.MeterStart,
                MeterEnd = r.MeterEnd,
                ProviderDebitAmount = r.ProviderDebitAmount,
                ProviderDebitDate = r.ProviderDebitDate,
                Notes = r.Notes
            };

        // Store original values for comparison
        originalValues = new UtilityReadingUpdate
            {
                Id = r.Id,
                UtilityTypeId = r.UtilityTypeId,
                UserId = r.UserId,
                UnitRate = r.UnitRate,
                StandingChargePerDay = r.StandingChargePerDay,
                VatRateFactor = r.VatRateFactor,
                ReadingStartDate = r.ReadingStartDate,
                ReadingEndDate = r.ReadingEndDate,
                MeterStart = r.MeterStart,
                MeterEnd = r.MeterEnd,
                ProviderDebitAmount = r.ProviderDebitAmount,
                ProviderDebitDate = r.ProviderDebitDate,
                Notes = r.Notes
            };

        isLoading = false;
    }

    private async Task HandleSaveClick()
    {
        // Validate the form
        if (editForm?.EditContext != null && editForm.EditContext.Validate())
        {
            // Form is valid, show confirmation modal
            showConfirmationModal = true;
            await InvokeAsync(StateHasChanged);
        }
        // If validation fails, the ValidationSummary will show errors
    }

    private async Task CancelConfirmation()
    {
        showConfirmationModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleCancelClick()
    {
        if (HasChanges)
        {
            showUnsavedChangesModal = true;
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            GoBack();
        }
    }

    private void ConfirmDiscardChanges()
    {
        showUnsavedChangesModal = false;
        GoBack();
    }

    private async Task CancelDiscardChanges()
    {
        showUnsavedChangesModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private bool HasChanges
    {
        get
        {
            return originalValues.UtilityTypeId != urUpdate.UtilityTypeId ||
                   originalValues.UnitRate != urUpdate.UnitRate ||
                   originalValues.StandingChargePerDay != urUpdate.StandingChargePerDay ||
                   originalValues.VatRateFactor != urUpdate.VatRateFactor ||
                   originalValues.ReadingStartDate != urUpdate.ReadingStartDate ||
                   originalValues.ReadingEndDate != urUpdate.ReadingEndDate ||
                   originalValues.MeterStart != urUpdate.MeterStart ||
                   originalValues.MeterEnd != urUpdate.MeterEnd ||
                   (originalValues.Notes ?? "") != (urUpdate.Notes ?? "");
        }
    }

    private List<(string Field, string OldValue, string NewValue)> GetChanges()
    {
        var changes = new List<(string, string, string)>();
        var originalTypeName = UtilityTypes.FirstOrDefault(t => t.Id == originalValues.UtilityTypeId)?.Name ?? "Unknown";
        var currentTypeName = currentUtilityTypeName ?? "Unknown";

        if (originalValues.UtilityTypeId != urUpdate.UtilityTypeId)
        {
            changes.Add(("Utility Type", originalTypeName, currentTypeName));
        }
        if (originalValues.ReadingStartDate != urUpdate.ReadingStartDate)
        {
            var origStart = originalValues.ReadingStartDate.HasValue ? originalValues.ReadingStartDate.Value.ToString("yyyy-MMM-dd") : "";
            var newStart = urUpdate.ReadingStartDate.HasValue ? urUpdate.ReadingStartDate.Value.ToString("yyyy-MMM-dd") : "";
            changes.Add(("Start Date", origStart, newStart));
        }
        if (originalValues.ReadingEndDate != urUpdate.ReadingEndDate)
        {
            var origEnd = originalValues.ReadingEndDate.HasValue ? originalValues.ReadingEndDate.Value.ToString("yyyy-MMM-dd") : "";
            var newEnd = urUpdate.ReadingEndDate.HasValue ? urUpdate.ReadingEndDate.Value.ToString("yyyy-MMM-dd") : "";
            changes.Add(("End Date", origEnd, newEnd));
        }
        if (originalValues.MeterStart != urUpdate.MeterStart)
        {
            var origMeterStart = originalValues.MeterStart.HasValue ? originalValues.MeterStart.Value.ToString("0.###") : "";
            var newMeterStart = urUpdate.MeterStart.HasValue ? urUpdate.MeterStart.Value.ToString("0.###") : "";
            changes.Add(("Meter Start", origMeterStart, newMeterStart));
        }
        if (originalValues.MeterEnd != urUpdate.MeterEnd)
        {
            var origMeterEnd = originalValues.MeterEnd.HasValue ? originalValues.MeterEnd.Value.ToString("0.###") : "";
            var newMeterEnd = urUpdate.MeterEnd.HasValue ? urUpdate.MeterEnd.Value.ToString("0.###") : "";
            changes.Add(("Meter End", origMeterEnd, newMeterEnd));
        }
        if (originalValues.UnitRate != urUpdate.UnitRate)
        {
            changes.Add(("Unit Rate", originalValues.UnitRate?.ToPounds(3) ?? "", urUpdate.UnitRate?.ToPounds(3) ?? ""));
        }
        if (originalValues.StandingChargePerDay != urUpdate.StandingChargePerDay)
        {
            changes.Add(("Standing Charge/Day", originalValues.StandingChargePerDay?.ToPounds(3) ?? "", urUpdate.StandingChargePerDay?.ToPounds(3) ?? ""));
        }
        if (originalValues.VatRateFactor != urUpdate.VatRateFactor)
        {
            var origVat = originalValues.VatRateFactor.HasValue ? PercentUtils.FactorToPercentString(originalValues.VatRateFactor.Value, 1) : "N/A";
            var newVat = urUpdate.VatRateFactor.HasValue ? PercentUtils.FactorToPercentString(urUpdate.VatRateFactor.Value, 1) : "N/A";
            changes.Add(("VAT Rate", origVat, newVat));
        }
        if ((originalValues.Notes ?? "") != (urUpdate.Notes ?? ""))
        {
            changes.Add(("Notes", originalValues.Notes ?? "(empty)", urUpdate.Notes ?? "(empty)"));
        }

        return changes;
    }

    private async Task HandleValidSubmit()
    {
        showConfirmationModal = false;
        await InvokeAsync(StateHasChanged);

        if (string.IsNullOrEmpty(userID))
        {
            ToastService.ShowError("Not signed in.");
            return;
        }

        // Client-side checks (leave your business rules intact)
        if (urUpdate.ReadingEndDate < urUpdate.ReadingStartDate)
        {
            ToastService.ShowError("End date must be on or after Start date.");
            return;
        }
        if (urUpdate.MeterEnd < urUpdate.MeterStart)
        {
            ToastService.ShowError("Meter end must be >= Meter start.");
            return;
        }
        if (urUpdate.UtilityTypeId == 4 && urUpdate.StandingChargePerDay != 0)
        {
            ToastService.ShowError("Hot Water must have Standing charge/day = 0.");
            return;
        }

        // ✅ use injected handler
        var result = await UtilityUpdateHandler.UpdateUtilityReading(urUpdate);
        if (result.IsSuccess)
        {
            ToastService.ShowSuccess("Reading updated.");
            NavManager.NavigateTo("/utility-readings");
        }
        else
        {
            ToastService.ShowError($"Update failed. {result.ErrorMessage}");
        }
    }

    private void GoBack() => NavManager.NavigateTo($"/utility-readings/view/{urUpdate.Id}");
}
